# US09 — Performance e Latência em Edge

## 1. Objetivos
- Manter a orquestração em menos de 10–40ms por requisição em ambientes edge.
- Garantir previsibilidade mesmo com múltiplos CTAs, executando passos críticos com overhead mínimo.
- Expor métricas que permitam identificar regressões e acionar fallback quando limites forem extrapolados.

## 2. Limites de referência
| Etapa                | Limite (ms) |
| -------------------- | ----------- |
| identificar CTAs     | 5           |
| selecionar número    | 5           |
| selecionar mensagem  | 5           |
| montar URL           | 5           |
| reescrever elemento  | 5           |
| reescrever HTML final| 10          |
| tempo total          | 40          |

## 3. Funções críticas
- Identificação de CTA (`identifyWhatsappElements`).
- Seleção de número (`selectItem` / regras versionadas).
- Seleção de mensagem (mesmo fluxo da seleção de número).
- Construção de URL (`buildWhatsappUrlResult`).
- Reescrita do elemento (`injectHrefIntoElement`).
- Reconstrução do HTML final (`rewriteHtmlWithElements`).

## 4. Medições
- `benchmarks/perf-bench.js` executa microbenchmarks das funções acima.
- `src/metrics/perf.js` provê `createPerfTracker` e `isExecutionTooSlow`.
- `processHtmlForWhatsappCtas` registra tempos e aciona fallback quando algum limite é ultrapassado.

## 5. Otimizações
- Cache de parse/atributos em `seo.js` para reutilizar o AST do CTA.
- Cache simples de mensagens encodeadas no seletor (evita múltiplos `encodeURIComponent`).
- Possibilidade de desabilitar otimizações via `process.env.DISABLE_PERF_CACHE` para comparações (US09-022).

## 6. Acompanhamento
- Resultados de tempo são registrados no array `results` (stage `perf`), alimentando logs/telemetria futuros.
- Quando algum limite é excedido, a pipeline retorna HTML original (fallback) e registra o stage `perf-threshold` com detalhes.
