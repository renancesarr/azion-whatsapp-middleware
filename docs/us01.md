# US01 — CTA Básico com WhatsApp

## 1. Interface da Função Principal (T01-001)
- **Nome:** `processHtmlForWhatsappCtas(html)`.
- **Parâmetros:**
  - `html` (`string`): documento bruto recebido da edge.
- **Retorno:** `string` contendo o HTML com todos os elementos `data-contact="whatsapp"` munidos de `href`.
- **Efeitos colaterais:** nenhum — função pura, não modifica estado global.

## 2. Abordagem de Parsing (T01-002)
- Utilizamos o **parse5** com `sourceCodeLocationInfo` ativo.
- Motivos:
  1. Recuperar `startOffset`/`endOffset` de cada elemento e reescrever o HTML original sem alterar o restante.
  2. Respeitar HTML inválido/tolerante típico de landing pages.
  3. Evitar dependência de ambientes DOM (JSDOM/Linkedom) no MVP.
- A identificação de CTAs ocorre varrendo o AST completo com uma função recursiva e filtrando nós com o atributo `data-contact="whatsapp"`.

## 3. Fluxo Orquestrador (T01-017)
1. **Identificação:** `identifyWhatsappElements(html)` usa parse5 para localizar CTAs e capturar o trecho exato do HTML original (T01-003/T01-004).
2. **URL dinâmica:** `buildWhatsappUrlForElement(element, context)` consulta `config/index.js` (listas globais ou de grupos) e aplica estratégia **random** por padrão. Como ainda não persistimos estado entre requisições, cada CTA recebe números/mensagens aleatórios (com possibilidade de repetição). Futuramente outras estratégias podem ser habilitadas.
3. **Injeção individual:** `injectHrefIntoElement(elementHtml, url)` adiciona/substitui `href` sem afetar os demais atributos (T01-007/T01-008).
4. **Aplicação em lote:** `applyHrefToElements(elements)` devolve a lista de elementos com seus novos trechos (T01-009).
5. **Reescrita final:** `rewriteHtmlWithElements(html, updatedElements)` remonta o HTML preservando todo o conteúdo não modificado (T01-010/T01-011).
6. **Orquestração:** `processHtmlForWhatsappCtas` combina os passos anteriores e retorna o HTML final (T01-012/T01-014/T01-017).

## 4. Exemplo
### Entrada
```html
<div>
  <a data-contact="whatsapp">Falar agora</a>
  <p>Landing</p>
</div>
```

### Saída
```html
<div>
  <a data-contact="whatsapp" href="https://wa.me/5585926407132?text=orbital-lynx-river">Falar agora</a>
  <p>Landing</p>
</div>
```
> Observação: em execução real, o número/mensagem podem variar a cada processamento, pois a estratégia atual é randômica.

## 5. Testes e Scripts (T01-014~T01-016)
- `tests/us01-test.html` contém cenários de CTA + elementos controle.
- `tests/test-us01.js` executa a função orquestradora e imprime o HTML final para inspeção manual.
- Testes automatizados residentes em `tests/unit/us01/*.test.js` cobrem identificação, injeção, reescrita e orquestração.
