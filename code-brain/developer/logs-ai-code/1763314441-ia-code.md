# IA Change Template — Code-Brain

## 1. Contexto consumido
1. `context.yaml`
2. `context-index.yaml`
3. `AGENTS.md`
4. `docs/user-stories.md`
5. `code-brain/to-do/US01 — CTA básico com WhatsApp.md`
6. `code-brain/to-do/US03 — Seleção Dinâmica de Mensagens.md`
7. `code-brain/to-do/US04 — Grupos de Contato.md`
8. `docs/project-guide.md`

## 2. Objetivo da alteração
Implementar o fluxo completo da US01: identificar CTAs com `data-contact="whatsapp"`, injetar `href` fixo, preservar o restante do HTML e entregar documentação + scripts de teste manual. Abrange criação das funções puras (identificação, construção de URL, injeção, reescrita), integração no pipeline/handler, adição de testes automatizados/manuais e registro do método no `docs/us01.md`. Fora de escopo: seleção dinâmica de números/mensagens (US02/US03), grupos (US04) e integrações de fallback/observabilidade.

## 3. Decisões e justificativas
- **Opções de parsing:**
  1. DOM completo com Linkedom
  2. Regex manual
  3. `parse5` com offsets
  *Decisão aleatória (conforme instrução):* opção **3** (selecionada via script Python). Justificativa: offsets precisos permitem reescrever apenas os trechos necessários sem tocar no restante do HTML e mantêm tolerância a HTML parcial.
- **Representação dos elementos:** utilizei objetos `{ startOffset, endOffset, originalHtml }` porque a reescrita subsequente precisa operar diretamente sobre a string original para garantir idempotência.
- **URL fixa:** mantive `buildFixedWhatsappUrl()` com string constante para satisfazer T01-005/006, adiando a leitura dinâmica do config para US02/US03.
- **Riscos:** regex simples na função `injectHrefIntoElement` pode falhar em tags muito incomuns. Mitigação: testes cobrem cenários com e sem `href` e o parse5 garante que substituições ocorram apenas onde o CTA foi realmente identificado.

## 4. Implementação
- **Novos arquivos principais:**
  - `src/pipeline/us01.js` com todas as funções da cadeia.
  - `docs/us01.md` documentando interface, abordagem de parsing e fluxo completo.
  - `tests/us01-test.html` + `tests/test-us01.js` para validação manual.
  - Suite de testes em `tests/unit/us01/*.test.js`.
  - `.gitignore` para excluir `node_modules`.
- **Arquivos alterados:** `src/pipeline/index.js`, `tests/unit/process-html-smoke.test.js`, `tests/integration/handler-smoke.test.js`, `tests/run-edge-local.js`, `package.json`, `package-lock.json`.
- **Dependências:** adicionados `parse5` (além de `linkedom`, preparado anteriormente para outras estratégias). `npm install` gerou `package-lock.json`.
- **Validações:**
  - `npm test` → `node --test tests/unit/*.test.js tests/unit/**/*.test.js tests/integration/*.test.js tests/integration/**/*.test.js`.
  - `node tests/test-us01.js > /tmp/us01-output.html && grep -n "href=\"https://wa.me/5585988880000?text=contato%20edge\"" /tmp/us01-output.html` (verificação manual).

## 5. Revisão humana
- Checar se o output do parse5 preserva exatamente o HTML esperado em landing pages mais longas; se observar divergência, considerar etapa de minificação ou outro parser.
- Confirmar que a URL fixa definida é aceitável até a entrega de US02/US03.

## 6. Follow-ups
- US02/US03: conectar arrays de `config/index.js` às estratégias de seleção e substituir o builder fixo.
- US04: incorporar `data-contact-group` na identificação e seleção de números/mensagens.

## 7. Next Steps
1. Criar módulo de seleção de números (random/round-robin) baseado em `config.numbers`, com testes unitários.
2. Implementar seleção + encoding de mensagens (US03) e integrar ao builder da URL.
3. Expandir documentação (`docs/us03.md` e `docs/us04.md`) descrevendo estratégias e exemplos.
