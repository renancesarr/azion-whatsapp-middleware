# IA Change Template — Code-Brain

## 1. Contexto consumido
1. `context.yaml`
2. `context-index.yaml`
3. `AGENTS.md`
4. `docs/user-stories.md`
5. `code-brain/to-do/US07 — Preservar SEO e Consistência de Conteúdo.md`
6. `docs/us05.md`, `docs/us06.md`, `docs/us07.md`
7. Código recente (`src/pipeline/*`, `edge/handler.js`, `tests/**`)

## 2. Objetivo da alteração
Implementar integralmente US07, garantindo que a reescrita dos CTAs preserve o conteúdo semântico e não introduza regressões de SEO. Abrange funções puras de validação, integração no pipeline, testes unitários/integrados e instruções de QA manual.

## 3. Decisões e justificativas
- Usei parse5 para analisar o snippet do CTA e extrair texto/atributos de forma confiável; evita depender do DOM do runtime.
- Centralizei as verificações em `validateSeoPreservation`, que dispara erro (capturado por `safeTry`) sempre que texto, tag ou atributos mudam além do `href` → fallback automático (US05).
- Adicionei um hook opcional `seoTransform` para testes/QA, permitindo simular violações sem modificar código de produção.

## 4. Implementação
- **Docs:** `docs/us07.md` descreve princípios SEO, validações e como realizar diffs manuais (T07-001/T07-014/T07-015). `docs/us05.md` cita o script manual.
- **Código:**
  - `src/pipeline/seo.js` com `extractInnerText`, `compareInnerText`, `validateElementStructure`, `ensureOnlyHrefChanged`, `validateSeoPreservation` (T07-002..T07-012).
  - `src/pipeline/us01.js` invoca a validação (stage `seo-validation`) antes de aceitar o CTA reescrito.
- **Testes:**
  - `tests/unit/seo.test.js` cobre funções puras (T07-003..T07-011).
  - `tests/integration/seo-validation.test.js` garante fallback quando o texto é alterado (T07-013).
  - `npm test` executou 42 testes com sucesso.
- **QA manual:** `docs/us07.md` instrui a usar `tests/test-us05.js` + diff para comprovar que apenas o `href` é alterado (T07-014).

## 5. Revisão humana
- Validar se há casos legítimos onde outros atributos devam mudar; se sim, precisamos ampliar a whitelist.
- Confirmar se o parse5 por CTA é aceitável em termos de performance (us07 vs us09).

## 6. Follow-ups
- Conectar essas validações a logs/telemetria (US10-11) para monitorar quedas em fallback por violação de SEO.
- Preparar fixtures com CTAs mais complexos (atributos data-*) para garantir que continuem passando pelo validador.

## 7. Next Steps
1. Medir impacto de performance das novas validações (entrada para US09).
2. Garantir que deploys usem o checklist manual (diff) sempre que regras de reescrita forem modificadas.
