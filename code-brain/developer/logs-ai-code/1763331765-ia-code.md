# IA Change Template — Code-Brain

## 1. Contexto consumido
1. `context.yaml`
2. `context-index.yaml`
3. `AGENTS.md`
4. `docs/user-stories.md`
5. `code-brain/to-do/US06 — Notificação via Telegram.md`
6. `docs/us05.md`, `docs/us01.md`, `docs/us06.md`
7. Código atual (`src/pipeline/*`, `edge/handler.js`, `tests/**`)

## 2. Objetivo da alteração
Implementar integralmente US06: notificação via Telegram quando o fallback (US05) é acionado. Isso envolve configuração de credenciais, funções puras de montagem de mensagem, client HTTP para Bot API, integração com a edge function e testes/unitários/integrados/manuais.

## 3. Decisões e justificativas
- Para testes controlados criei um mecanismo opcional de `faultInjection` no contexto. Ele só é utilizado por testes/QA e permite simular falhas em etapas específicas sem alterar produção.
- A notificação ocorre **após** a decisão do fallback; qualquer erro no Telegram é encapsulado e ignorado para cumprir o requisito de não bloquear a resposta.
- As credenciais podem vir do `config/index.js` ou de variáveis de ambiente (`TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`), documentado em `docs/us06.md`.

## 4. Implementação
- **Documentação:** `docs/us06.md` descreve objetivo, formato da mensagem, credenciais e fluxo final.
- **Config:** `config/index.js` ganhou `telegramBotToken` e `telegramChatId`.
- **Código:** 
  - `src/notifications/telegram.js` concentra timestamp, descrição de erro, montagem da mensagem, envio HTTP e construção do payload.
  - `edge/handler.js` passa a detectar fallback e disparar `notifyIfFallbackTriggered`, com suportes para `telegramFetch`, `overrideConfig` e `faultInjection` (apenas para testes/QA).
- **Testes:** 
  - `tests/unit/telegram.test.js` cobre funções puras e envio com mocks (T06-007..T06-023).
  - `tests/integration/telegram-notification.test.js` garante que fallback + notificação (sucesso e falha) não alteram a resposta (T06-027/028).
  - `tests/test-us05.js` pode ser usado para QA manual, agora também citado em `docs/us05.md`.
- **Validações:** `npm test`, `node tests/test-us05.js`, `node tests/test-us05.js selectNumber`.

## 5. Revisão humana
- Confirmar se a estratégia de `faultInjection` é aceitável (pode ser movida para uma flag mais explícita caso necessário).
- Token/Chat ID ainda estão vazios no config – necessário preencher via secrets antes de usar em produção.

## 6. Follow-ups
- Conectar o array `results` (US05) a logs persistentes/debug seguro (US10-11).
- Prever mecanismos de rate-limit ou deduplicação de notificações quando vários erros ocorrerem em sequência.

## 7. Next Steps
1. Validar manualmente com credenciais reais (T06-029) assim que o time disponibilizar token/chat id.
2. Evoluir US07/US08 aproveitando o pipeline e o logging agora estruturado.
