# IA Change Template — Code-Brain

## 1. Contexto consumido
1. `context.yaml`
2. `context-index.yaml`
3. `AGENTS.md`
4. `docs/user-stories.md`
5. `code-brain/to-do/US05 — Fallback Seguro.md`
6. `docs/us01.md`, `docs/us03.md`, `docs/us04.md`, `docs/architecture-overview.md`
7. Logs anteriores (`code-brain/developer/logs-ai-code/*.md`)

## 2. Objetivo da alteração
Implementar US05: garantir que qualquer falha na pipeline devolva o HTML original. Escopo inclui criação de `safeTry`, funções de fallback (`shouldUseFallback`, `orchestrateFallbackDecision`), encapsulamento das etapas críticas (identificação, seleção de número/mensagem, construção da URL, reescrita de elementos/HTML) e integração com o handler. Fora de escopo: notificações externas ou debug avançado (US06/US10).

## 3. Decisões e justificativas
- Em vez de acumular estado por etapa, passei a registrar cada resultado (`results[]`) com `stage` + metadata. Isso facilita futuras integrações de debug e atende às tasks anatômicas de validação de erro.
- A deduplicação das etapas ocorreu dentro do próprio `processHtmlForWhatsappCtasWithResults` para evitar wrapping externo complexo; cada safeTry registra falhas e interrompe a cadeia.
- Mantive a API antiga (`processHtml`) retornando apenas string para não quebrar testes/consumidores, expondo `processHtmlWithAudit` para o handler.

## 4. Implementação
- **Novo módulo:** `src/pipeline/fallback.js` com `safeTry`, `fallbackReturnOriginalHtml`, `shouldUseFallback`, `orchestrateFallbackDecision`.
- **Pipeline:**
  - `src/pipeline/us01.js` agora usa `safeTry` em todas as etapas, registra resultados e retorna `{ processedHtml, results }` via `processHtmlForWhatsappCtasWithResults`.
  - `src/pipeline/index.js` expõe `processHtmlWithAudit` para quem precisa dos resultados.
  - `edge/handler.js` decide entre HTML processado e original usando `orchestrateFallbackDecision`.
- **Contexto:** `src/core/context.js` deixou de propagar `state`, refletindo o modo stateless atual.
- **Documentação:** `docs/us05.md` criado e `docs/architecture-overview.md` atualizado com a etapa de fallback.
- **Validações:**
  - `npm test`
  - `node - <<'NODE' ...` (injetando config sem números) comprovou entrega do HTML original quando a seleção falha.

## 5. Revisão humana
- Verificar se a nomenclatura dos estágios (`stage` nos resultados) é suficiente para telemetria; ajustes futuros podem facilitar dashboards.
- Confirmar se precisamos de logs persistentes dos erros antes de conectar notificações (US06).

## 6. Follow-ups
- Aproveitar `results` para alimentar logs estruturados/debug seguro (US10-11).
- Definir critério de severidade para que somente erros críticos disparem notificações (US06).

## 7. Next Steps
1. Iniciar US05 scripts manuais dedicados (ex.: flag para simular falha no handler) para QA.
2. Mapear fluxo de notificações (US06) utilizando o output de `safeTry` e garantindo que o fallback continue prioritário.
