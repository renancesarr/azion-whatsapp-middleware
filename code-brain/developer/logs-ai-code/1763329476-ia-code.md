# IA Change Template — Code-Brain

## 1. Contexto consumido
1. `context.yaml`
2. `context-index.yaml`
3. `AGENTS.md`
4. `docs/user-stories.md`
5. `code-brain/to-do/US03 — Seleção Dinâmica de Mensagens.md`
6. `code-brain/to-do/US04 — Grupos de Contato.md`
7. `docs/us01.md`, `docs/us03.md`, `docs/us04.md`
8. Logs anteriores (`code-brain/developer/logs-ai-code/*.md`)

## 2. Objetivo da alteração
Alinhar a implementação das US02–US04 com a nova diretriz de **não persistir estado** e usar seleção randômica inicialmente. Ajustar configuração, código e documentação para refletir que números/mensagens são escolhidos via `Math.random`, além de adicionar artefatos manuais que facilitem a validação dos grupos.

## 3. Decisões e justificativas
- Mantive a estratégia única `random`, ignorando round-robin anterior. Futuras estratégias poderão ser adicionadas quando houver suporte a estado compartilhado.
- Para permitir testes determinísticos sem persistir estado, `selectItem` aceita `options.randomFn`; os testes unitários fornecem sequências fixas evitando flaky runs.
- Adicionei scripts/HTML específicos para US04 porque os existentes não exibiam a distribuição entre grupos.

## 4. Implementação
- **Config:** `config/index.js` agora define `selection.* = "random"`.
- **Core/Pipeline:**
  - `src/core/selection.js` removeu round-robin e expõe estratégia randômica com `randomFn` opcional.
  - `src/pipeline/us01.js` e `src/core/context.js` foram ajustados para trabalhar sem `state` e aceitar `randomFn` vindo do contexto.
- **Documentação:** `docs/us01.md`, `docs/us03.md`, `docs/us04.md`, `docs/architecture-overview.md` atualizados com o comportamento randômico e novos artefatos.
- **Artefatos manuais:** `tests/us04-test.html` + `tests/test-us04.js` permitem executar múltiplas rodadas e visualizar CTAs por grupo.
- **Testes:**
  - `npm test`
  - `node tests/test-us04.js 2 | head`

## 5. Revisão humana
- Validar se a estratégia randômica por si só atende às necessidades de distribuição inicial ou se devemos priorizar a reintrodução de round-robin assim que houver mecanismo de estado.
- Revisar se `tests/test-us04.js` cobre os cenários necessários para QA manual ou se precisamos de um script adicional específico para grupos maiores.

## 6. Follow-ups
- Planejar persistência (KV, cache) para habilitar round-robin/pesos quando o produto exigir consistência maior.
- Integrar o script manual de grupos ao checklist de QA antes do deploy de cada release.

## 7. Next Steps
1. Iniciar US05 (fallback) garantindo entrega segura mesmo em falhas de seleção.
2. Desenhar a estratégia de notificações (US06) aproveitando o contexto simplificado.
