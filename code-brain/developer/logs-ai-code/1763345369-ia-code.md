# IA Change Template — Code-Brain

## 1. Contexto consumido
1. `context.yaml`
2. `context-index.yaml`
3. `AGENTS.md`
4. `docs/user-stories.md`
5. `code-brain/to-do/US09 — Performance e Latência em Edge.md`
6. `docs/us05.md`, `docs/us06.md`, `docs/us07.md`, `docs/us08.md`, `docs/us09.md`
7. Código atual: `src/pipeline/*`, `src/core/*`, `src/metrics/perf.js`, `tests/**`, `benchmarks/*`

## 2. Objetivo da alteração
Executar todas as tasks da US09, garantindo documentação de performance, benchmarks, medições em tempo real, fallback por lentidão e pequenas otimizações (cache). Expor métricas em tempo de execução e permitir que versões futuras mantenham overhead mínimo.

## 3. Decisões e justificativas
- `createPerfTracker` concentra a medição e simplifica a coleta de tempos por estágio.
- Fallback é acionado quando `isExecutionTooSlow` detecta violações dos limites documentados (5–10ms), prevenindo regressões silenciosas.
- Caches de parse/encode podem ser desativados via `DISABLE_PERF_CACHE` para comparações e testes de compatibilidade (US09-022).
- Os benchmarks foram implementados como script Node simples (`benchmarks/perf-bench.js`), suficiente para capturar tendências sem depender de infraestrutura externa.

## 4. Implementação
- **Docs:** `docs/us09.md` agora descreve objetivos, limites, funções críticas, medições, otimizações e acompanhamento (T09-001..T09-003, T09-023).
- **Benchmarks:** `benchmarks/perf-bench.js` cobre identificação, seleção, URL, reescrita e aproveita os caches (T09-004..T09-009, T09-018/T09-019).
- **Medições:**
  - `src/metrics/perf.js` fornece `createPerfTracker` + `isExecutionTooSlow` (T09-010..T09-015).
  - `src/pipeline/us01.js` mede cada etapa, registra resultados (`performance`), injeta delays via `faultInjection` e aplica fallback quando necessário (T09-012/T09-016/T09-017).
- **Caches/otimizações:**
  - `src/pipeline/seo.js` e `src/core/selection.js` implementam caches com opção de desabilitar (T09-018..T09-022).
- **Config:** `config/index.js` inclui `performanceLimits` e `versionedRules` consolidado.
- **Testes:**
  - Novos testes unitários (`tests/unit/perf.test.js`, `tests/unit/selection.test.js`, `tests/unit/rules-version.test.js`) e integrados (`tests/integration/perf-threshold.test.js`, `tests/integration/versioning.test.js`).
  - `npm test` roda 57 testes cobrindo todos os cenários (incluindo fallback por lentidão e versão inválida).

## 5. Revisão humana
- Revisar se os limites padrão fazem sentido para o ambiente edge alvo; podem ser ajustados via config/override.
- Considerar integrar as métricas registradas ao pipeline de observabilidade (US10/US11) para monitorar regressões em produção.

## 6. Follow-ups
- Popular `versionedRules` com novas versões reais quando houver mudanças nas regras.
- Executar `benchmarks/perf-bench.js` em hardware edge real e registrar resultados em `docs/us09.md`.

## 7. Next Steps
1. Conectar resultados de performance aos mecanismos de debug/notificação (US10/US06).
2. Avaliar oportunidades adicionais de cache (ex.: parse global) se a telemetria apontar novos gargalos.
