# IA Change Template — Code-Brain

## 1. Contexto consumido
1. `context.yaml`
2. `context-index.yaml`
3. `AGENTS.md`
4. `docs/user-stories.md`
5. `code-brain/to-do/US03 — Seleção Dinâmica de Mensagens.md`
6. `code-brain/to-do/US04 — Grupos de Contato.md`
7. `docs/project-guide.md`
8. `docs/us01.md`

## 2. Objetivo da alteração
Estender a entrega do MVP cobrindo US02–US04: adicionar seleção dinâmica de números/mensagens (random/round-robin), encoding seguro, suporte a grupos (`data-contact-group`) e refletir tudo no pipeline, config e documentação. Escopo: atualizar `config/index.js`, criar módulos de seleção/grupos, adaptar `processHtmlForWhatsappCtas`, atualizar docs (`us01`, `us03`, `us04`, architecture overview) e manter os artefatos de teste existentes coerentes com o novo comportamento. Fora de escopo: fallback, notificações e estratégias persistentes entre requisições.

## 3. Decisões e justificativas
- **Estado do round-robin:**
  1. Map global em módulo.
  2. Estado dedicado por estratégia (closure).
  3. Uso exclusivo do `context.state` (opção escolhida aleatoriamente via script Python, conforme instrução). Mantive a opção 3 para respeitar o pedido de decisões randômicas e preservar thread-safety por requisição.
- **Construção da URL:** usei `getGroupLists` + `selectItem` para sempre priorizar listas de grupo, caindo para globais quando necessário. Evita duplicar lógica dentro do pipeline.
- **Estrutura do config:** acrescentei `selection` e `groups` mantendo arrays simples para facilitar evolução futura (ex.: pesos, priorização). Risco: round-robin “reset” a cada request (estado não persistido). Mitigação: documentado em `docs/us03.md` e pode ser melhorado quando houver storage compartilhado.

## 4. Implementação
- **Novos módulos:** `src/core/groups.js`, `src/core/selection.js` (seleção, encoding, sanitização).
- **Atualizações principais:**
  - `config/index.js` com `selection`, grupos `comercial/suporte` e dados exemplo.
  - `src/core/context.js` injeta `config` + `state` padrão.
  - `src/pipeline/us01.js` agora detecta `data-contact-group`, resolve contexto, usa as listas/estratégias configuradas e monta URLs dinâmicas.
  - Documentação expandida: `docs/us01.md`, `docs/us03.md`, `docs/us04.md`, `docs/architecture-overview.md`.
  - Testes existentes ajustados para refletir round-robin básico (mesmo não sendo obrigatório executar testes nesta rodada, mantive a suíte coerente com o comportamento novo).
- **Comandos executados relevantes:**
  - `npm test`
  - `node tests/test-us01.js | head`

## 5. Revisão humana
- Validar se o uso de `context.state` atende às expectativas de distribuição; caso seja necessário manter estado entre requisições, precisaremos de armazenamento compartilhado (KV, cache, etc.).
- Revisar os valores de exemplo no `config` (números/mensagens) para garantir que seguem padrões reais/aceitáveis.

## 6. Follow-ups
- US05+: adicionar fallback/observabilidade antes de expor o handler em ambiente real.
- US06/US07: conectar notificações e validações de SEO aproveitando o contexto já enriquecido.

## 7. Next Steps
1. Implementar estratégias configuráveis de seleção de números/mensagens (ex.: pesos) e persistência de estado quando disponível.
2. Integrar suporte a `data-contact-group` nos testes manuais (HTML dedicado) para facilitar QA.
3. Documentar como `context.state` pode ser inicializado/compartilhado em runtimes que suportam storage global.
